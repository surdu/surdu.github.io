I"È<p>I have a server at my home on which I host various test projects and I needed a dynamic DNS service as my ISP assigns me an IP dynamically. Tried some dynamic DNS services, but their domain names tend to get long, and I don‚Äôt like typing URLS. So I decided to buy a domain and handle the DNS update myself.</p>

<p>What we‚Äôll do is a script that finds out what our IP is and then tells it to DigitalOcean. This script will run at a specified interval on our server.</p>

<p>For this you‚Äôll need a UNIX machine, a <a href="https://www.digitalocean.com/">DigitalOcean</a> account and a domain pointed to DigitalOcean‚Äôs Nameservers.</p>

<p>To see how to point your domain to DigitalOcean check <a href="https://www.digitalocean.com/community/tutorials/how-to-point-to-digitalocean-nameservers-from-common-domain-registrars">this article</a> or check with your domain‚Äôs registrar on how to do it, as it vary from one to another.</p>

<p>Also, we‚Äôll use <code class="highlighter-rouge">cron</code> in this tutorial, so if you‚Äôre not familiar with it please read <a href="https://www.digitalocean.com/community/tutorials/how-to-use-cron-to-automate-tasks-on-a-vps">this tutorial</a> before.</p>

<p>I will not cover in detail what needs to be done on DigitalOcean‚Äôs side, as their documentations covers it already. I‚Äôll mostly list the steps needed along with the links in their documentation:</p>

<ol>
  <li><a href="https://www.digitalocean.com/docs/api/create-personal-access-token/">Generate an access token</a></li>
  <li><a href="https://www.digitalocean.com/docs/projects/how-to/create/">Create a project</a></li>
  <li><a href="https://www.digitalocean.com/docs/networking/dns/how-to/add-domains/">Add domains to the created project</a></li>
  <li><a href="https://www.digitalocean.com/docs/networking/dns/how-to/manage-records/#a-records">Add at least one <code class="highlighter-rouge">A</code> record to your DNS records</a>.</li>
</ol>

<p>In my case, I added two <code class="highlighter-rouge">A</code> DNS records:</p>

<p><img src="/assets/images/do-dns/records.jpg" alt="Example records" /></p>

<p>The first one is the required one, and will point <code class="highlighter-rouge">example.com</code> domain to my machine. The second one will point all sub-domains of <code class="highlighter-rouge">example.com</code> (like <code class="highlighter-rouge">test.example.com</code>) to my machine.</p>

<p>For the first one enter <code class="highlighter-rouge">@</code> in the <code class="highlighter-rouge">Hostname</code> field when you create the record, and for the second one enter <code class="highlighter-rouge">*</code>. As for the IP, it doesn‚Äôt matter what you enter as it will be automatically updated later by our script.</p>

<p>This should be all that you need to do on the side of DigitalOcean.</p>

<p>Now let‚Äôs write a bash script that will update DigitalOcean‚Äôs DNS records with our IP.</p>

<p>Create a file called <code class="highlighter-rouge">update-dns.sh</code> with the following contents:</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="update-ddns.sh"></gist>

<p>After you created the file, let‚Äôs give it execution rights by executing the following in your terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x update-dns.sh
</code></pre></div></div>

<p>Now let‚Äôs go step by step and see what we need to change and what the script actually does.</p>

<p>The things we need to change are at the top of the file. We‚Äôll start by changing line 3 where we need to add the access token that we generated above in step 1 on DigitalOcean. Should look something like this:</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="update-ddns-filled.sh" data-line="3" data-showFooter="false">
</gist>

<p>Next thing to change it‚Äôs pretty straight forward: at line 4, set the domain for which to update the DNS records. In our example, this is <code class="highlighter-rouge">example.com</code>.</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="update-ddns-filled.sh" data-line="4" data-showFooter="false">
</gist>

<p>Lastly, we‚Äôll need to tell our script what are the ids for the DNS records. For this, we‚Äôll use this little script to list all our DigitalOcean DNS records for our domain:</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="get_dns.sh"></gist>

<p>At the top of this script, just change the <code class="highlighter-rouge">ACCESS_TOKEN</code> and <code class="highlighter-rouge">DOMAIN</code> to match our initial script.</p>

<p>The output of this script will be groups of three key/value pairs: the <code class="highlighter-rouge">id</code> of the record, the <code class="highlighter-rouge">type</code> of the record and <code class="highlighter-rouge">data</code>, which is the value of the record.</p>

<p>This is the output for our example:</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="get_dns_output.txt"></gist>

<p>From this, we only care about the <code class="highlighter-rouge">id</code> of our <code class="highlighter-rouge">A</code> DNS records. From the above output we can determine that those IDs are <code class="highlighter-rouge">76145698</code> and <code class="highlighter-rouge">76145705</code>. So we change our initial script accordingly:</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="update-ddns-filled.sh" data-line="5" data-showFooter="false">
</gist>

<p>Our DNS update script should be looking like this:</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="update-ddns-filled.sh">
</gist>

<p>As for what the script actually does:</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="update-ddns-filled.sh" data-line="7" data-showFooter="false">
</gist>

<p>The above gets your current IP using an Amazon AWS service. For alternative services, you can consult <a href="https://openwrt.org/docs/guide-user/services/ddns/client#detecting_public_ip">this list on OpenWRT</a>.</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="update-ddns-filled.sh" data-line="9-18" data-showFooter="false">
</gist>

<p>The above will call the DigitalOcean API for each record id that you have defined at line 5, as documented in <a href="https://developers.digitalocean.com/documentation/v2/#update-a-domain-record">DigitalOcean‚Äôs API documentation</a>.</p>

<p>You can now give it a quick test to see if it works as intended. Execute the script in your terminal by typing <code class="highlighter-rouge">./update-ddns.sh</code>. If it worked correctly, you should now see the DNS records updated on DigitalOcean.</p>

<p>Seeing the script works, we can set it as a <code class="highlighter-rouge">cron</code> job so it will update the DNS every 20 minutes.</p>

<p>Adding the following line in your <code class="highlighter-rouge">crontab</code> will do just that:</p>

<gist id="gist-aa01a6093a52b3fc7f6e91852beb9b69" data-file="cron" data-line="1" data-showFooter="false">
</gist>

<p>And just like that we have our own dynamic DNS system up and running.</p>

<p>Alternatively to the <code class="highlighter-rouge">cron</code> solution, if you have an Asus router and you can run <a href="https://www.asuswrt-merlin.net/">Asuswrt-Merlin firmware</a> on it, you could set the DNS update script to be executed by the router every time your IP changes. Please see <a href="https://github.com/RMerl/asuswrt-merlin.ng/wiki/Custom-DDNS">their docs</a> and the <a href="https://github.com/RMerl/asuswrt-merlin.ng/wiki/DDNS-Sample-Scripts#digitalocean">adaptation of our script</a> in order to achieve this.</p>

<p>Others routers should support this, so check your router‚Äôs manual to see if you can set up a custom dynamic DNS script on your router.</p>

<p>Hope this helps ‚úåÔ∏è</p>
:ET